/*!
    eba -- Effortless bible analysis
    Version 0.0.3-2017.04.03
    https://scriptive.github.io/eba
    (c) 2017
*/
!function(e){e.merge({config:{name:"EBA alpha",description:"Effortless bible analysis",author:"tuang",version:"0.0.3",build:"1.0.0",id:"eba",idUnique:"eba:unique",developer:"Khen Solomon Lethil",file:{template:"z.html",lang:"lang/book.json",urlLocal:"eba/bId.xml",urlAPI:["lang/bId.xml"]},fileStorage:{RequestQuota:1073741824,Permission:1,objectStore:{name:"eba",version:1}},lang:{isLocalRemove:'Would you like to remove "{is}" from local?',tryAWord:"Try a word or two!",noMatchFor:"No match for {for}!",noCategoryContent:"This category has no content...",noCategoryData:"This category has no data...",noBookmark:"No Bookmark...",isNotFound:'Not found: "{is}"'},classname:{active:"active",inactive:"inactive",filter:"filter"},page:{home:{id:1,name:"Home",class:"icon-home"},book:{id:2,name:"Book",class:"icon-language"},catalog:{id:3,name:"Catalog",class:"icon-book"},reader:{id:4,name:"Reader",class:"icon-chapter"},lookup:{id:5,name:"Lookup",class:"icon-lookup"},bookmark:{id:6,name:"Bookmark",class:"icon-bookmark"},setting:{id:7,name:"Setting",class:"icon-setting"},about:{id:8,name:"About",class:"icon-info"}}},initiate:function(){var n=e.config,t=e.localStorage;n.pageHome=Object.keys(n.page)[0];var a=function(){var a=t.select("book").name.book;return new Promise(function(o,r){e.fileStorage=fileStorage(n.fileStorage,{success:function(){e.fileStorage.download({url:n.file.lang}).then(function(r){if(e.book.all=JSON.parse(r.data),a.isObject()||(a={}),a.isEmpty()||(e.book.all=JSON.parse(JSON.stringify(a)).merge(e.book.all)),n.requireUpdate||a.isEmpty()){for(var i in e.book.all)e.book.all.hasOwnProperty(i)&&(a.hasOwnProperty(i)||(a[i]={}),a[i].hasOwnProperty("id")||(a[i].id={}),e.book.all[i].hasOwnProperty("id")||(e.book.all[i].id={}));t.update("book")}o()},function(e){r(e)})},fail:function(e){r(e)}})}).then(function(){return!0},function(e){return e})},o=function(){var e=t.name.query,a={page:n.pageHome,book:"eba",category:1,q:"",pagePrevious:n.pageHome,result:""},o={page:function(e,t,a,o){o[e]=n.page.hasOwnProperty(t.toLowerCase())?t.toLowerCase():a},pagePrevious:function(e,t,a,o){o[e]&&n.page.hasOwnProperty(o[e])?a!=o.page&&(o[e]=n.page[a].id<=n.page[o.page].id?a:n.pageHome):o[e]=a,n[e]=o[e]},q:function(e,n,t,a){a[e]=decodeURIComponent(n)}};return new Promise(function(t,r){try{e.isEmpty()?e.merge(a,n.hash):(a.pagePrevious=e.page,e.merge(n.hash)),e.each(function(e,n,t){o.isFunction(e)&&o[e](e,n,a[e],t)}),t()}catch(e){r(e)}}).then(function(){return t.update("query"),!0},function(e){return e})},r=function(){return e.fileStorage.download({url:n.file.template.replace(/z/,["default","desktop"].join(".")),before:function(e){e.overrideMimeType("text/html; charset=utf-8"),e.responseType="document"}}).then(function(e){try{for(var n=e.data.body;n.firstChild;)document.body.appendChild(n.firstChild);return i().then(function(e){return e===!0&&document.querySelector("div#screen").remove(),e})}catch(e){return e}},function(e){return e})},i=function(){return o().then(function(n){return n===!0?new Promise(function(n,a){e.page[t.name.query.page](n,a)}).then(function(){return e.Toggle.header().then(function(n){try{e.dataContent()}catch(e){return e}return!0})},function(e){return e}):n})};new Promise(function(o,i){t.select("setting").select("query").select("todo"),t.select("bookmark").select("suggestion"),t.name.setting.hasOwnProperty("build")?t.name.setting.build==n.build?n.requireUpdate=0:n.requireUpdate=2:n.requireUpdate=1,n.requireUpdate&&(t.name.setting.version=n.version,t.name.setting.build=n.build,t.update("setting")),a().then(function(n){return document.body.classList.add(e.config.Screen),t.name.setting.hasOwnProperty("class")?t.name.setting.class.each(function(e,n){document.body.classList.add(n)}):t.name.setting.class={},n===!0?r():n}).then(function(e){e===!0?o():i(e)})}).then(function(){e.hashChange(function(){i().then(function(e){e!==!0&&console.log("page error",e)})})},function(n){"object"==typeof n&&n.hasOwnProperty("message")?e.notification(n.message):"string"==typeof n&&e.notification(n)})},dialog:{container:function(){return e.elementSelect("div#dialog")}},nav:{container:function(){return e.elementSelect("nav")},toHome:function(n){window.location.hash=e.config.pageHome},toPrevious:function(n){window.location.hash=n.dataset.hasOwnProperty("page")?n.dataset.page:e.config.pagePrevious},setNamePrevious:function(n){n.innerHTML=e.localStorage.name.query.page,n.eventClick(function(){window.location.hash=n.dataset.hasOwnProperty("page")?n.dataset.page:e.config.pagePrevious})},setTitle:function(n){n.innerHTML=e.config.name},setName:function(n){n.innerHTML=e.localStorage.name.query.page},setReader:function(n){e.Toggle.menu(n,function(n){var t=n.appendChild(e.elementCreate("ol"));e.config.catalog.each(function(n,a){a.each(function(n,a){t.appendChild(e.elementCreate("li").addAttr("data-cls",a.class).addAttr("data-title",a.total).eventClick(function(n){n.target.toggleClass("active"),e.Toggle.main().querySelectorAll("ol li ol li").each(function(e,n){n.hasClass(a.class)&&n.toggleDisplay()})}).addContent(a.name).addClass("active"))})})},function(){})}},header:{container:function(){return e.elementSelect("header")},lookup:function(n){var t=n.querySelector("input").addAttr("placeholder",e.localStorage.name.query.q||"search...");t.eventHandler("focus",function(){document.body.classList.add("lookup"),window.scrollTo(0,0),document.body.scrollTop=0}),t.eventHandler("focusout",function(){document.body.classList.remove("lookup")}),n.eventHandler("submit",function(n){var t={q:n.target.elements.q.value},a=e.config.hash;t.q==a.q&&a.page==n.target.name&&(t.i=(new Date).getTime()),window.location.hash=t.paramater([n.target.name]),n.preventDefault()})}},main:{container:function(){return e.elementSelect("main")}},footer:{container:function(){return e.elementSelect("footer")}},page:{home:function(n,t){var a=e.config,o=(e.localStorage,e.elementCreate("ol"));e.Toggle.main(!0).appendChild(o).setAttribute("class","main-home"),a.page.each(function(n,t){var a=o.appendChild(e.elementCreate("li")),r=a.appendChild(e.elementCreate("a"));r.addClass(t.class).addAttr("href","#"+n).innerHTML=t.name}),n()},book:function(n,t){var a=e.config,o=e.localStorage,r=o.name.book,i=e.elementCreate("ol");e.Toggle.main(!0).appendChild(i).setAttribute("class","main-book"),e.book.all.each(function(n,t){var l=i.appendChild(e.elementCreate("li")),c=r.hasOwnProperty(n)&&r[n].id.hasOwnProperty("local")?"icon-ok offline":"icon-cloud online",s=l.appendChild(e.elementCreate("div"));s.eventClick(function(i){var l=i.target;if(l.classList.contains("offline"))e.Toggle.dialog(function(n){var o=n.appendChild(e.elementCreate("p"));o.innerHTML=a.lang.isLocalRemove.replace("{is}",t.name)},function(t){return new e.xml(n).delete().then(function(){r[n].hasOwnProperty("name")?(delete r[n],l.parentNode.removeElement(),o.update("book")):l.addAttr("class","icon-cloud online")})});else{l.parentNode.firstElementChild.nextElementSibling;new e.xml(n).download(function(){l.addAttr("class","icon-loading animate-spin")}).then(function(t){new e.xml(n).save(t).then(function(){l.addAttr("class","icon-ok offline")},function(){l.addAttr("class","icon-attention offline")})},function(){l.addAttr("class","icon-cloud online")})}}).addAttr("class",c);var d=l.appendChild(e.elementCreate("div"));d.addAttr("data-description",t.description).eventClick(function(){window.location.hash={book:n}.paramater(["#catalog"])}).innerHTML=t.name});var l=function(e){return new Promise(function(n,t){function a(e){return r="",i=1,o(e)}function o(e){var n,t=e.nodeName;if("h3"==t){if(0==i)return;i=0}for("#text"==t&&(r=e.nodeValue),n=0;n<e.childNodes.length;n++)o(e.childNodes[n])}var r="",i=1;if(document.implementation.createDocument){try{var l=(new DOMParser).parseFromString(e,"application/xml")}catch(e){return t(e.message)}l.getElementsByTagName("parsererror").length>0?(a(l.getElementsByTagName("parsererror")[0]),t(r)):n(l)}else t("Your browser cannot handle XML validation")})},c=e.elementCreate("ol").addClass("main-upload");c.appendChild(e.elementCreate("li")).addContent("This section might not work on mobile devices, and testing purpose only!"),c.appendChild(e.elementCreate("li")).appendChild(e.elementCreate("input")).addAttr("type","file").addAttr("id","file").addAttr("name","file").addAttr("accept",".xml").eventHandler("change",function(n){var t=n.target.parentNode.parentNode,i=t.firstChild,c=(t.parentNode.firstChild,n.target.files[0]),s=c.name.replace(/\.[^\/.]+$/,""),d=new FileReader;d.onerror=function(e){console.log("error",e)},d.onprogress=function(e){},d.onabort=function(e){},d.onloadstart=function(e){},d.onload=function(n){l(n.target.result).then(function(t){var i=t.querySelector("eba info");r[s]={id:{local:!0},name:i.querySelector("name").innerHTML,description:i.querySelector("desc").innerHTML},e.book.all[s]=r[s],o.update("book");var l={i:(new Date).getTime()};e.fileStorage.save({urlLocal:a.file.urlLocal.replace(/bId/,s),data:n.target.result,fileType:c.type}).then(function(e){window.location.hash=l.paramater("#book")},function(e){console.log("fail")}).then(function(e){console.log("done")})},function(e){i.innerHTML=e})},d.readAsText(c)}),e.Toggle.main().appendChild(c),n()},catalog:function(n,t){var a=e.config,o=e.localStorage,r=e.elementCreate("ol");e.Toggle.main(!0).appendChild(r).setAttribute("class","main-catalog"),new e.Content(o.name.query.book).xml().then(function(e){e.section(r).then(function(e){},function(e){console.log(e)})},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=a.lang.isNotFound.replace("{is}",o.name.query.book)}).then(function(){n()})},reader:function(n,t){var a=e.config,o=e.localStorage,r=e.elementCreate("ol");e.Toggle.main(!0).appendChild(r).setAttribute("class","main-reader"),new e.Content(o.name.query.book).xml().then(function(n){n.reader(r,o.name.query.category).then(function(e){},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=n})},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=a.lang.isNotFound.replace("{is}",o.name.query.book)}).then(function(){n()})},lookup:function(n,t){var a=e.config,o=e.localStorage,r=e.elementCreate("ol");e.Toggle.main(!0).appendChild(r).setAttribute("class","main-reader"),new e.Content(o.name.query.book).xml().then(function(n){o.name.query.q?n.lookup(r,o.name.query.q).then(function(e){},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=n.replace("{for}",o.name.query.q)}):r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=a.lang.tryAWord},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=a.lang.isNotFound.replace("{is}",o.name.query.book)}).then(function(){n(),console.log("done")})},bookmark:function(n,t){var a=e.config,o=e.localStorage,r=e.elementCreate("ol");e.Toggle.main(!0).appendChild(r).setAttribute("class","main-reader"),new e.Content(o.name.query.book).xml().then(function(n){n.bookmark(r).then(function(e){console.log(e)},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=n})},function(n){r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=a.lang.isNotFound.replace("{is}",o.name.query.book)}).then(function(){n()})},setting:function(n,t){var a=e.config,o=e.localStorage,r=o.name.setting,i=e.elementCreate("ol"),l={fontsize:{title:"font size",style:"body {font-size:$100%;}",option:{"80%":{title:"1",class:"size-small-extra"},"90%":{title:"2",class:"size-small"},"100%":{title:"3",class:"size-normal",defaults:!0},"120%":{title:"4",class:"size-large"},"150%":{title:"5",class:"size-large-extra"}}},background:{title:"background color",style:"body {background-color:$white;}",option:{"#ffffff":{class:"color-white"},"#F8F8F8":{class:"color-lightgray",defaults:!0},"#7f7f7f":{class:"color-dimgrey"},"#b97a59":{class:"color-chocolate"},"#880016":{class:"color-darkred"},"#ed1b24":{class:"color-red"},"#fef102":{class:"color-gold"},"#24b04d":{class:"color-green"},"#3f47cc":{class:"color-darkblue"}}}};e.Toggle.main(!0).appendChild(i).setAttribute("class","main-setting"),r.hasOwnProperty("class")||(r.class={}),l.each(function(n,t){var l=i.appendChild(e.elementCreate("li"));l.appendChild(e.elementCreate("h3")).innerHTML=t.title;var c=l.appendChild(e.elementCreate("ol")).addClass(n);t.option.each(function(t,i){var l=c.appendChild(e.elementCreate("li")).addClass(i.class).addClass("icon-ok");if(i.hasOwnProperty("title")&&l.addAttr("data-title",i.title),r.class.hasOwnProperty(n))var s=r.class[n]==i.class?a.classname.active:a.classname.inactive;else if(i.hasOwnProperty("defaults"))var s=a.classname.active;else var s=a.classname.inactive;l.addClass(s).eventClick(function(e){var t=e.target;t.hasClass(a.classname.active)||(t.parentNode.getElementsByClassName(a.classname.active).each(function(e,n){n.removeClass(a.classname.active)}),t.addClass(a.classname.active),r.class.hasOwnProperty(n)&&document.body.hasClass(r.class[n])&&document.body.removeClass(r.class[n]),document.body.hasClass(i.class)||document.body.addClass(i.class),r.class[n]=i.class,o.update("setting"))})})}),n()},about:function(n,t){var a=e.config,o=e.elementCreate("ol");e.Toggle.main(!0).appendChild(o).setAttribute("class","main-about");var r={name:a.name,version:a.version,description:a.description,author:a.author};r.each(function(n,t){var a=o.appendChild(e.elementCreate("li")).addClass(n);a.innerHTML=t}),n()}},xml:function(n){var t=e.config,a=e.book,o="book",r=e.localStorage.name,i=this;this.open=function(){return e.fileStorage.open({urlLocal:t.file.urlLocal.replace(/bId/,n),readAs:"readAsText"})},this.download=function(o){var r={dir:JSON.parse(JSON.stringify(t.file.urlAPI)),request:function(a){return e.fileStorage.download({url:a,urlLocal:t.file.urlLocal.replace(/bId/,n),before:function(e){e.overrideMimeType("text/xml; charset=utf-8")},progress:o})},process:function(e,t){var o=r.dir.shift().replace(/bId/,n);return r.request(o).then(function(t){t.xml||(t.xml=(new DOMParser).parseFromString(t.data,t.fileType)),a.file[n]=t.xml,e(t)},function(n){r.dir.length?r.process(e,t):t(n)})}};return new Promise(r.process)},this.save=function(t){return new Promise(function(i,l){e.fileStorage.save(t).then(function(t){a.all[n].id.local=1,r[o][n].id.local=1,e.localStorage.update(o),i(t)},function(e){l(e)})})},this.delete=function(){return new Promise(function(i,l){e.fileStorage.delete({urlLocal:t.file.urlLocal.replace(/bId/,n),fileNotFound:!0}).then(function(t){delete a.all[n].id.local,delete r[o][n].id.local,delete a.file[n],e.localStorage.update(o),i(t)},function(e){l(e)})})},this.request=function(e){return new Promise(function(t,l){a.file.hasOwnProperty(n)?t(a.file[n]):r[o][n].id.hasOwnProperty("local")?i.open().then(function(e){e.xml=(new DOMParser).parseFromString(e.fileContent,e.fileType),a.file[n]=e.xml,t(e.xml)},function(e){console.log("open fail",e),i.delete().then(function(){l(e)})}):i.download(e).then(function(e){i.save(e).then(function(){console.log("save success")},function(){console.log("save fail")}).then(function(){t(e.xml)})},function(e){l(e)})})}},Content:function(n){var t,a=e.config,o=e.localStorage,r={category:0,section:0,verse:0};a.catalog={};var i=function(n,t,o){return new Promise(function(i,l){var c=s(o);return c.length?(c.each(function(i,l){var c,s=o?o:l.getAttribute("id");l.querySelectorAll(f()).each(function(o,i){var l=t(i);if(l){c||(c=g.createOl(n,s)),r.verse++;var d=i.getAttribute("book"),f=d<=39?1:2,h=i.getAttribute("chapter"),C=i.getAttribute("verse"),v=i.getAttribute("tag"),b=p(f).innerHTML,y=u(d).innerHTML,k=m(v).innerHTML,w=e.book.hasBookmark(s,d,h,C)?a.classname.active:a.classname.inactive,T=b.replace(" ","-").toLowerCase(),L=y.replace(" ","-").toLowerCase(),A=k.replace(" ","-").toLowerCase(),S=c.appendChild(e.elementCreate("li")).addClass(w).addClass(T).addClass(L).addClass(A),q=(S.appendChild(e.elementCreate("div")).addClass("icon-bookmark").eventClick(function(n){e.book.addBookmark(n.target.parentNode,s,d,h,C)}),S.appendChild(e.elementCreate("div")));q.addAttr("data-title","123 234:345".replace(123,y).replace(234,h).replace(345,C)),q.innerHTML=g.replaceNumber(l);var P=q.appendChild(e.elementCreate("p"));P.appendChild(e.elementCreate("span")).innerHTML=b,P.appendChild(e.elementCreate("span")).innerHTML=y,P.appendChild(e.elementCreate("span")).innerHTML=k,a.catalog.hasOwnProperty("tag")||(a.catalog.tag={}),a.catalog.tag.hasOwnProperty(v)?a.catalog.tag[v].total++:(a.catalog.tag[v]={},a.catalog.tag[v].total=1,a.catalog.tag[v].name=k,a.catalog.tag[v].class=A)}})}),void(r.verse?i(r):l(o?a.lang.noCategoryContent:a.lang.noMatchFor))):l(a.lang.noCategoryData)})},l=function(){return t.querySelectorAll("index section")},c=function(e){return t.querySelector('index section[id="0"]'.replace(0,e))},s=function(e){return t.querySelectorAll(e?'book category[id="0"]'.replace(0,e):"book category")},d=function(e){return t.querySelectorAll('book category[id="0"] verse'.replace(0,e))},u=function(e){return t.querySelector('bookname row[id="0"]'.replace(0,e))},p=function(e){return t.querySelector('testament row[id="0"]'.replace(0,e))},m=function(e){return t.querySelector('tag row[id="0"]'.replace(0,e))},f=function(e,n,t,a){var o="verse";return e&&(o+='[book="0"]'.replace(0,e)),n&&(o+='[chapter="0"]'.replace(0,n)),t&&(o+='[verse="0"]'.replace(0,t)),a&&(o+='[tag="0"]'.replace(0,a)),o},g={replaceKeyword:function(e,n){return"string"==typeof n?e.replace(new RegExp(n,"gi"),"<b>$&</b>"):e},replaceNumber:function(e){return e.replace(/\d+/g,"<sup>$&</sup>")},createOl:function(n,t){r.category++;var a=c(t),o=n.appendChild(e.elementCreate("li"));o.appendChild(e.elementCreate("h2")).addAttr("data-description",a.innerHTML).innerHTML=a.getAttribute("name");return o.appendChild(e.elementCreate("ol"))}},h={section:function(n){return new Promise(function(t,a){l().each(function(t,a){r.section++;var o=a.getAttribute("id"),i=a.getAttribute("name");a.innerHTML;n.appendChild(e.elementCreate("li")).addClass("icon-arrow-right").addAttr("data-title",o).appendChild(e.elementCreate("a")).addAttr("data-total",d(o).length).addAttr("data-description",a.innerHTML).addAttr("href",{category:o}.paramater(["#reader"])).innerHTML=i}),t(r)})},reader:function(e,n){return i(e,function(e){return e.innerHTML},n)},lookup:function(e,n){return i(e,function(e){if(new RegExp(n,"i").test(e.innerHTML))return g.replaceKeyword(e.innerHTML,n)})},bookmark:function(n){return new Promise(function(t,i){o.name.bookmark.each(function(t,o){var i;o.each(function(o,l){l.each(function(l,c){c.each(function(c,d){s(t).each(function(c,s){s.querySelectorAll(f(o,l,d)).each(function(c,s){i||(i=g.createOl(n,t)),r.verse++;var m=o<=39?1:2,f=p(m).innerHTML,h=u(o).innerHTML,C=f.replace(" ","-").toLowerCase(),v=h.replace(" ","-").toLowerCase(),b=i.appendChild(e.elementCreate("li")).addClass(a.classname.active).addClass(C).addClass(v),y=(b.appendChild(e.elementCreate("div")).addClass("icon-bookmark").eventClick(function(n){var r=n.target.parentNode;e.book.addBookmark(r,t,o,l,d),r=r.removeElement(),""===r.innerHTML&&(r=r.parentNode.removeElement(),""===r.innerHTML&&(r.addAttr("class","msg").appendChild(e.elementCreate("li")).appendChild(e.elementCreate("div")).innerHTML=a.lang.noBookmark))}),b.appendChild(e.elementCreate("div")));y.addAttr("data-title","123 234:345".replace(123,h).replace(234,l).replace(345,d)),y.innerHTML=g.replaceNumber(s.innerHTML)})})})})})}),r.verse?t(r):i(a.lang.noBookmark)})}};this.xml=function(){return new Promise(function(a,o){new e.xml(n).request(function(){}).then(function(e){t=e,a(h)},function(e){o(e)})})}},book:{file:{},addBookmark:function(n,t,a,o,r){var i=e.localStorage,l=i.name.bookmark;n.hasClass(e.config.classname.active)?(l[t][a][o].splice(l[t][a][o].indexOf(r),1),l[t][a][o].length<=0&&(delete l[t][a][o],l[t][a].isEmpty()&&(delete l[t][a],l[t].isEmpty()&&delete l[t])),n.removeClass(e.config.classname.active)):(l.hasOwnProperty(t)||(l[t]={}),l[t].hasOwnProperty(a)||(l[t][a]={}),l[t][a].hasOwnProperty(o)||(l[t][a][o]=[]),l[t][a][o].push(r.toString()),n.addClass(e.config.classname.active)),i.update("bookmark")},hasBookmark:function(n,t,a,o){var r=e.localStorage.name.bookmark;if(r.hasOwnProperty(n)&&r[n].hasOwnProperty(t)&&r[n][t].hasOwnProperty(a))return r[n][t][a].has(o)}}})}(scriptive("app"));